# Roadmap: IT-Start Bot / Core API

Пошаговый план от инициализации до продукта, полностью соответствующего ТЗ, user stories и уставу. Чекбоксы отражают текущий статус; отмеченные задачи уже реализованы в кодовой базе на 2025-12-09.

## Этап 0. Базовая инфраструктура и каркас
- [x] Скелет монорепо (FastAPI + aiogram 3 + общий доменный слой).
- [x] Базовые миграции, схемы БД и enum’ы синхронизированы с ТЗ.
- [x] Docker-compose (db, redis, core-api, tg-bot), env-конфигурация.
- [x] CI/CD заготовка: линтеры (black, isort, ruff), mypy, pytest, coverage.
- [x] Подключить Celery worker + beat как отдельные сервисы в docker-compose.
- [x] Настроить автоматический запуск Alembic миграций при деплое.

## Этап 1. Доменные модели и данные
- [x] SQLAlchemy модели и репозитории для публикаций, тегов, пользователей бота, подписок, предпочтений, парсеров, результатов парсинга, админов, расписаний.
- [x] Pydantic-схемы (read) и тесты на них.
- [ ] Обновить `docs/db_schemes.sql` под актуальные миграции (status, decline_reason, contact_info, schedule, audit, deadline_notified, user_preferences, parser поля).
- [ ] Добавить типы публикаций/событий из устава (contests/hackathons) — приоритезировать после согласования.

## Этап 2. Аутентификация и безопасность
- [x] JWT login/refresh, Argon2 пароли, rate-limit логина, white-list IP.
- [x] TOTP 2FA, запрет отключения для admin.
- [ ] Централизованный VPN/IP enforcement (прокси/ingress уровень) + док.
- [x] Распределённый rate-limit (Redis) вместо in-memory.
- [ ] Регулярный аудит прав и ролей (admin/moderator) и логов действий по всем CRUD.

## Этап 3. Админка (Core API)
- [x] Admin users: list/create/patch/disable + аудит.
- [x] Tags CRUD + сидинг базовых значений по категориям.
- [x] Publications: list/get/patch(status/title/description/contact_info/deadline), decline, approve.
- [ ] Добавить создание/удаление публикаций в API, валидация уникальности/дедуп.
- [ ] `approve-and-send` должен реально инициировать рассылку (канал + подписчики) с пометкой [UPD] для изменённых записей.
- [ ] Отображение editor_id и статусов модерации в ответах/фронте.
- [x] Parsers CRUD/enable/disable.
- [ ] Хранение результатов парсинга в привязке к запуску, статус/ошибки.
- [x] Publication schedule CRUD (таблица schedule).
- [ ] Связать schedule с планировщиком (Celery beat) и cron-интервалами.
- [x] Stats: пользователи, топ-5 тегов, ошибки парсеров, публикации по дням.
- [x] Export CSV/XLSX публикаций за период.
- [ ] Экспорт в Google Sheets (устав).

## Этап 4. Парсеры
- [ ] Реализовать модуль запуска парсеров (external executable) с конфигом из БД.
- [ ] Повторные попытки 15/45 мин при ошибках; логгирование в Sentry.
- [ ] Авто-дедуп: URL + (title + company + дата) — soft блокировка дублей.
- [ ] Авто-тегирование по словарю тегов из БД (поиск подстрок, морфология опционально).
- [ ] Минимум 5 источников (hh.ru, habr career, tbank, sber, vk work; конференции).
- [ ] Протоколировать в `parsing_result` (success, count, timestamp, parser_id).
- [ ] Интегрировать скрипты парсеров из `docs/Парсеры.zip`: поправить заполнение `description`, добавить обработку/логирование ошибок, покрыть юнит- и интеграционными тестами.
- [ ] Упаковать парсеры в Docker-образ и добавить сервис(ы) в `docker-compose` для их запуска/планировщика.

## Этап 5. Телеграм-бот
- [x] Команды /start, /help, /subscribe, /unsubscribe, /preferences, /jobs, /internships, /conferences.
- [x] FSM для поэтапной подписки/отписки; проверки occupation/platform/language для jobs/internships.
- [x] Кэш поиска в Redis; обработка блокировки (my_chat_member) с очисткой данных.
- [ ] Хранить FSM в Redis (Memory → Redis storage) для отказоустойчивости.
- [ ] Инлайн-кнопки для всех основных команд + /settings для включения/выключения напоминаний.
- [ ] Поддержка новых типов (contests/hackathons) и локализация подсказок.
- [ ] Канальный постинг [UPD] при редактировании ранее отправленных публикаций.

## Этап 6. Рассылки и уведомления
- [x] Celery задачи: рассылка новых публикаций, дедлайны (3 дня), cleanup >90 дней.
- [x] Подключить Celery beat расписания: публикации по `publication_schedule`, дедлайны раз в сутки, cleanup раз в сутки.
- [ ] Персональные напоминания: уважать флаг `deadline_reminder` в подписке, дать управление из бота (/settings) и админки.

## Этап 7. Мониторинг, логирование, резервирование
- [x] Sentry для API/бота; Prometheus /metrics.
- [ ] Sentry для Celery/парсеров; отдельный тег сервиса в событиях.
- [ ] Grafana дашборд (метрики: req rate/latency, celery queue, парсеры, ошибки).
- [ ] Резервные копии БД (ежедневно, хранение 3 месяца) + восстановление по регламенту.
- [ ] Уведомления о критических ошибках в TG-группу разработчиков.

## Этап 8. Производительность и масштабирование
- [ ] Нагрузочное тестирование: 5000+ одновременных пользователей, отклик <1s.
- [ ] Профилирование длительных операций (поиск, рассылка) и кеширование горячих выборок.
- [ ] Горизонтальное масштабирование бота (webhook/polling) и API (uvicorn workers, DB pool).

## Этап 9. Качество и тестирование
- [x] Модульные/интеграционные тесты (ORM, репозитории, API, бот-сервис, Celery задачи, безопасность, rate-limit, healthz, metrics).
- [ ] E2E: сценарий “парсинг → модерация → рассылка → дедлайн напоминание → отписка”.
- [ ] Контрактные тесты для парсеров (стаб источников).
- [ ] Тесты на экспорт (CSV/XLSX/Sheets) и на расписания.
- [ ] Регулярные отчёты coverage >=80% доменной логики.

## Этап 10. Документация и ввод в эксплуатацию
- [ ] Обновить README/architecture/TЗ с фактами реализации (сервисы, порты, переменные окружения, расписания).
- [ ] Описать playbook деплоя и восстановления из бэкапа.
- [ ] Пользовательская документация админки и бота (команды, фильтры, ограничения).
- [ ] Провести приемочное тестирование по user stories и критериям устава; подписать акт.

## Рекомендованный порядок исполнения спринтов (2-недели)
1. Инфра и планировщик: Celery worker/beat, миграции автозапуск, distributed rate-limit.
2. Парсеры: модуль запуска, ретраи, логирование, результаты; 2–3 источника.
3. Рассылки end-to-end: approve-and-send, [UPD], дедлайны флаг/команда, канал.
4. FSM в Redis + инлайн-UX + /settings; добавить contests если подтверждено.
5. Оставшиеся источники парсеров + авто-тегирование + дедуп.
6. Экспорт Sheets, бэкапы, мониторинг (Grafana), алерты.
7. Нагрузочные/E2E тесты, документация, приемка.
